<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>entity/collision.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Body.html">Body</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#.detectCollision">detectCollision</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#.fromObject">fromObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#applyImpulse">applyImpulse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#calculateAxes">calculateAxes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#calculateMinMaxes">calculateMinMaxes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#containsPoint">containsPoint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#fixDown">fixDown</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#move">move</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#rotate">rotate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#scaleAround">scaleAround</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#scaleAroundX">scaleAroundX</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#scaleAroundY">scaleAroundY</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Body.html#velInPlace">velInPlace</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Line.html">Line</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Line.html#.intersect">intersect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Line.html#.intersectWithLineSegment">intersectWithLineSegment</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Line.html#distFromPoint">distFromPoint</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LineSegment.html">LineSegment</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="LineSegment.html#.intersect">intersect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="LineSegment.html#distFromPoint">distFromPoint</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MinMax.html">MinMax</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Physics.html">Physics</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#.fromObject">fromObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#addBody">addBody</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#addFixedBall">addFixedBall</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#addRectBody">addRectBody</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#addRectWall">addRectWall</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#addSoftSquare">addSoftSquare</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#addSpring">addSpring</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#getObjectAtCoordinates">getObjectAtCoordinates</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#getObjectIdentifier">getObjectIdentifier</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#getSpringsWithBody">getSpringsWithBody</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#removeObjFromSystem">removeObjFromSystem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#setAirFriction">setAirFriction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#setBounds">setBounds</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#setGravity">setGravity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#stickOrSpringFromObject">stickOrSpringFromObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#toJSON">toJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Physics.html#update">update</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Polygon.html">Polygon</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Polygon.html#.createCircle">createCircle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Polygon.html#.fracture">fracture</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Polygon.html#.intersection">intersection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Polygon.html#getSideLine">getSideLine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Polygon.html#getSideSegment">getSideSegment</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Polygon.html#getSideVector">getSideVector</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Polygon.html#isPointInside">isPointInside</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Polygon.html#makeAntiClockwise">makeAntiClockwise</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Polygon.html#reverseOrder">reverseOrder</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Shape.html">Shape</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#.Circle">Circle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#.fromObject">fromObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#.Polygon">Polygon</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#containsPoint">containsPoint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#getClosestPoint">getClosestPoint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#getGeometricalData">getGeometricalData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#getMinMaxInDirection">getMinMaxInDirection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#getMinMaxX">getMinMaxX</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#getMinMaxY">getMinMaxY</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#move">move</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Shape.html#rotateAround">rotateAround</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Spring.html">Spring</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Spring.html#arrangeOrientations">arrangeOrientations</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Spring.html#attachObject">attachObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Spring.html#getAsSegment">getAsSegment</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Spring.html#lockRotation">lockRotation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Spring.html#pinHere">pinHere</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Spring.html#unlockRotation">unlockRotation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Spring.html#unpin">unpin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Spring.html#update">update</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Spring.html#updateAttachPoint0">updateAttachPoint0</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Spring.html#updateAttachPoint1">updateAttachPoint1</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Stick.html">Stick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stick.html#update">update</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stick.html#updateAttachPoint0">updateAttachPoint0</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stick.html#updateAttachPoint1">updateAttachPoint1</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Vec2.html">Vec2</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#add">add</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#dist">dist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#div">div</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#lerp">lerp</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#mult">mult</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#normalize">normalize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#pNorm">pNorm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#rotate">rotate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#rotate90">rotate90</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#rotate270">rotate270</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#scaleAround">scaleAround</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#scaleAroundX">scaleAroundX</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#scaleAroundY">scaleAroundY</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#setCoordinates">setCoordinates</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#setMag">setMag</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#sub">sub</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#toJSON">toJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.add">add</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.angle">angle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.angleACW">angleACW</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.cross">cross</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.crossScalarFirst">crossScalarFirst</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.crossScalarSecond">crossScalarSecond</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.dist">dist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.div">div</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.dot">dot</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.fromAngle">fromAngle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.fromAnglePNorm">fromAnglePNorm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.fromObject">fromObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.lerp">lerp</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.mult">mult</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.normalized">normalized</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.rotateArr">rotateArr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Vec2.html#.sub">sub</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#arrayBuffertoBase64">arrayBuffertoBase64</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#base64ToArrayBuffer">base64ToArrayBuffer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#codeTable">codeTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#collisionResponse">collisionResponse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#collisionResponseWithWall">collisionResponseWithWall</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#findOverlap">findOverlap</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#minMaxOfArray">minMaxOfArray</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#resolveCollisions">resolveCollisions</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">entity/collision.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Vec2 from '../math/vec2';
import Body from './body';

/**
 * @typedef {{dVel: Vec2, dAng: number}} ChangeOfMotion
 */

/**
 * Calculates the collsion response when any two physical objects
 * collide with a given collision point and collision normal.
 *
 * @param {Body} object1 The first object
 * @param {Body} object2 The second object
 * @param {Vec2} contactPoint The collision point
 * @param {Vec2} normal The normal of the colliding surfaces
 * @returns {ChangeOfMotion[]} The changes in the motion states
 */
export function collisionResponse(object1, object2, contactPoint, normal) {
  const n = normal;
  const cp = contactPoint;
  const b1 = object1;
  const b2 = object2;

  const v1 = b1.vel;
  const v2 = b2.vel;
  const ang1 = b1.ang;
  const ang2 = b2.ang;
  const r1 = Vec2.sub(cp, b1.pos);
  const r2 = Vec2.sub(cp, b2.pos);
  const am1 = b1.am;
  const am2 = b2.am;
  const m1 = b1.m;
  const m2 = b2.m;
  const k = (b1.k + b2.k) / 2;
  const fc = (b1.fc + b2.fc) / 2;

  // Effective velocities in the collision point
  const v1InCP = b1.velInPlace(cp);
  const v2InCP = b2.velInPlace(cp);
  // Relative velocity in collision point
  const vRelInCP = Vec2.sub(v2InCP, v1InCP);

  // Calculate impulse
  let impulse = (1 / m1) + (1 / m2);
  impulse += Vec2.dot(
    Vec2.crossScalarFirst(Vec2.cross(r1, n) / am1, r1), n,
  );
  impulse += Vec2.dot(
    Vec2.crossScalarFirst(Vec2.cross(r2, n) / am2, r2), n,
  );
  impulse = -((1 + k) * Vec2.dot(vRelInCP, n)) / impulse;

  // Calculate post-collision velocities
  let u1 = Vec2.sub(v1, Vec2.mult(n, impulse / m1));
  let u2 = Vec2.add(v2, Vec2.mult(n, impulse / m2));

  // Calculate post-collision angular velocities
  let pAng1 = ang1 - (impulse * Vec2.cross(r1, n)) / am1;
  let pAng2 = ang2 + (impulse * Vec2.cross(r2, n)) / am2;

  /**
   * Now calculate the friction reaction
   */
  // Tangential direction
  const t = vRelInCP.copy;
  t.sub(Vec2.mult(n, Vec2.dot(vRelInCP, n)));
  t.setMag(1);
  if ((Vec2.dot(n, t) ** 2) > 0.5) {
    // No friction impulse is needed, return
    return [
      { dVel: Vec2.sub(u1, b1.vel), dAng: pAng1 - b1.ang },
      { dVel: Vec2.sub(u2, b2.vel), dAng: pAng2 - b2.ang },
    ];
  }

  // Calculate max impulse
  let maxImpulse = (1 / m1) + (1 / m2);
  maxImpulse += Vec2.dot(
    Vec2.crossScalarFirst(Vec2.cross(r1, t) / am1, r1), t,
  );
  maxImpulse += Vec2.dot(
    Vec2.crossScalarFirst(Vec2.cross(r2, t) / am2, r2), t,
  );
  maxImpulse = -Vec2.dot(vRelInCP, t) / maxImpulse;

  // Friction impulse
  let frictionImpulse = Math.sign(maxImpulse) * impulse * fc;
  if (Math.abs(frictionImpulse) > Math.abs(maxImpulse)) frictionImpulse = maxImpulse;

  // Calculate post-friction velocities
  u1 = Vec2.sub(u1, Vec2.mult(t, frictionImpulse / m1));
  u2 = Vec2.add(u2, Vec2.mult(t, frictionImpulse / m2));

  // Calculate post-friction angular velocities
  pAng1 -= (frictionImpulse * Vec2.cross(r1, t)) / am1;
  pAng2 += (frictionImpulse * Vec2.cross(r2, t)) / am2;

  return [
    { dVel: Vec2.sub(u1, b1.vel), dAng: pAng1 - b1.ang },
    { dVel: Vec2.sub(u2, b2.vel), dAng: pAng2 - b2.ang },
  ];
}

/**
 * Calculates the collsion response when a physical object
 * collides with an immovable object, like a {@link Wall} or {@link FixedBall}.
 *
 * @param {Body} object The phyisical object
 * @param {Vec2 | import('../math/vec2').Vec2AsObject} contactPoint The collision point
 * @param {Vec2} normal The surface normal
 * @returns {ChangeOfMotion} The change of the motion state
 */
export function collisionResponseWithWall(object, contactPoint, normal) {
  const cp = contactPoint;
  const n = normal;
  const b = object;
  const r = Vec2.sub(cp, b.pos);
  const { am, m } = b;

  // Relative velocity in collision point
  const vRelInCP = Vec2.mult(b.velInPlace(cp), -1);

  // Calculate impulse
  let impulse = (1 / m);
  impulse += Vec2.dot(
    Vec2.crossScalarFirst(Vec2.cross(r, n) / am, r), n,
  );
  impulse = -((1 + b.k) * Vec2.dot(vRelInCP, n)) / impulse;

  // Calculate post-collision velocity
  let u = Vec2.sub(b.vel, Vec2.mult(n, impulse / m));

  // Calculate post-collision angular velocity
  let pAng = b.ang - (impulse * Vec2.cross(r, n)) / am;

  /**
   * Now calculate the friction reaction
   */
  // Tangential direction
  const t = vRelInCP.copy;
  t.sub(Vec2.mult(n, Vec2.dot(vRelInCP, n)));
  t.setMag(1);
  if ((Vec2.dot(n, t) ** 2) > 0.5) {
    // No friction impulse is needed, return
    return { dVel: Vec2.sub(u, b.vel), dAng: pAng - b.ang };
  }

  // Calculate max impulse
  let maxImpulse = (1 / m);
  maxImpulse += Vec2.dot(
    Vec2.crossScalarFirst(Vec2.cross(r, t) / am, r), t,
  );
  maxImpulse = -Vec2.dot(vRelInCP, t) / maxImpulse;

  // Friction impulse
  let frictionImpulse = Math.sign(maxImpulse) * impulse * b.fc;
  if (Math.abs(frictionImpulse) > Math.abs(maxImpulse)) frictionImpulse = maxImpulse;

  // Calculate post-friction velocity
  u = Vec2.sub(u, Vec2.mult(t, frictionImpulse / m));

  // Calculate post-friction angular velocity
  pAng -= (frictionImpulse * Vec2.cross(r, t)) / am;

  return { dVel: Vec2.sub(u, b.vel), dAng: pAng - b.ang };
}

/**
 * Calculates and applies all collisions on the bodies in the array
 *
 * @param {Body[]} bodies All bodies
 * @returns {import('../physics').CollisionData[]} All the collsions that occured
 */
export function resolveCollisions(bodies) {
  const collisions = [];
  const bodyCount = bodies.length;
  const moveAmountsX = Array(bodyCount).fill(0);
  const moveAmountsY = Array(bodyCount).fill(0);
  const collisionCounts = Array(bodyCount).fill(0);
  const dVelXs = Array(bodyCount).fill(0);
  const dVelYs = Array(bodyCount).fill(0);
  const dAngs = Array(bodyCount).fill(0);

  // Precalculate all minmaxes
  bodies.forEach((b) => b.calculateMinMaxes());

  for (let i = 0; i &lt; bodyCount - 1; i += 1) {
    for (let j = i + 1; j &lt; bodyCount; j += 1) {
      const b1 = bodies[i];
      const b2 = bodies[j];
      // eslint-disable-next-line no-continue
      if (b1.m === 0 &amp;&amp; b2.m === 0) continue;
      const collDat = Body.detectCollision(b1, b2);
      if (collDat &amp;&amp; typeof collDat !== 'boolean') {
        // Skip if moving away from each other
        const vInPlace1 = Vec2.dot(b1.velInPlace(collDat.contactPoint), collDat.normal);
        const vInPlace2 = Vec2.dot(b2.velInPlace(collDat.contactPoint), collDat.normal);
        collisions.push({ n: collDat.normal, cp: collDat.contactPoint });
        let toMove1 = -collDat.overlap;
        let toMove2 = collDat.overlap;
        if (b1.m === 0) {
          toMove1 = 0;
          const change1 = collisionResponseWithWall(
            b2, collDat.contactPoint, Vec2.mult(collDat.normal, -1),
          );
          dVelXs[j] += change1.dVel.x;
          dVelYs[j] += change1.dVel.y;
          dAngs[j] += change1.dAng;
          collisionCounts[j] += 1;
        } else if (b2.m === 0) {
          toMove2 = 0;
          const change2 = collisionResponseWithWall(
            b1, collDat.contactPoint, Vec2.mult(collDat.normal, 1),
          );
          dVelXs[i] += change2.dVel.x;
          dVelYs[i] += change2.dVel.y;
          dAngs[i] += change2.dAng;
          collisionCounts[i] += 1;
        } else {
          toMove1 *= (b2.m / (b1.m + b2.m));
          toMove2 *= (b1.m / (b1.m + b2.m));
          const [change1, change2] = collisionResponse(
            b1, b2, collDat.contactPoint, Vec2.mult(collDat.normal, 1),
          );
          if (vInPlace1 >= vInPlace2) {
            dVelXs[i] += change1.dVel.x;
            dVelYs[i] += change1.dVel.y;
            dAngs[i] += change1.dAng;
            dVelXs[j] += change2.dVel.x;
            dVelYs[j] += change2.dVel.y;
            dAngs[j] += change2.dAng;
          }
        }
        const toMove1V = Vec2.mult(collDat.normal, toMove1);
        const toMove2V = Vec2.mult(collDat.normal, toMove2);
        moveAmountsX[i] += toMove1V.x;
        moveAmountsX[j] += toMove2V.x;
        moveAmountsY[i] += toMove1V.y;
        moveAmountsY[j] += toMove2V.y;
      }
    }
  }

  for (let i = 0; i &lt; bodyCount; i += 1) {
    const b = bodies[i];
    // eslint-disable-next-line no-continue
    if (b.m === 0) continue;
    const cCount = Math.max(collisionCounts[i], 1);
    b.move(new Vec2(moveAmountsX[i], moveAmountsY[i]));
    b.vel.add(new Vec2(dVelXs[i] / cCount, dVelYs[i] / cCount));
    b.ang += dAngs[i] / cCount;
  }

  return collisions;
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Tue Feb 02 2021 04:42:31 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
